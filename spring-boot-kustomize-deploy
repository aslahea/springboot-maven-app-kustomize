pipeline {
    agent { label "k8s-node" }

    parameters {
        string(name: 'SOURCE_BUILD_NUMBER', description: 'Build number passed from CI Job')
    }

    environment {
        AWS_REGION = 'eu-north-1'
        AWS_CRED_ID = 'aws-ecr-creds' 
        S3_BUCKET = "s3://jenkins-artifacts-aslahea-2025"
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Download Artifact') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: AWS_CRED_ID,
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh '''
                        # --- FIX START: AWS CONFIGURATION ADDED ---
                        echo "Configuring AWS..."
                        aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
                        aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
                        aws configure set default.region $AWS_REGION
                        # --- FIX END ---

                        if [ -z "$SOURCE_BUILD_NUMBER" ]; then
                            echo "ERROR: SOURCE_BUILD_NUMBER is empty!"
                            exit 1
                        fi
        
                        echo "Downloading Artifact for Build: $SOURCE_BUILD_NUMBER"
                        aws s3 cp ${S3_BUCKET}/kustomize-pkg-${SOURCE_BUILD_NUMBER}.zip .
                        unzip -o kustomize-pkg-${SOURCE_BUILD_NUMBER}.zip
                    '''
                }
            }
        }

        stage('Deploy to DEV') {
            steps {
                dir('overlays/dev') {
                    sh 'echo "Deploying to DEV..."'
                    sh 'kubectl apply -k .'
                }
            }
        }

        stage('Verify DEV') {
            steps {
                sh 'sleep 5'
                // Grep used to find pods starting with dev-
                sh 'kubectl get pods | grep dev-' 
            }
        }

        // --- MANUAL APPROVAL (PROD) ---
        stage('Approval for PROD') {
            steps {
                script {
                    input message: 'Do you want to deploy to PRODUCTION?', ok: 'Deploy to Prod'
                }
            }
        }

        // --- PROD DEPLOYMENT ---
        stage('Deploy to PROD') {
            steps {
                dir('overlays/prod') {
                    sh 'echo "Deploying to PRODUCTION..."'
                    sh 'kubectl apply -k .'
                }
            }
        }

        stage('Verify PROD') {
            steps {
                sh 'sleep 5'
                // Grep used to find pods starting with prod-
                sh 'kubectl get pods | grep prod-'
            }
        }
    }
}
