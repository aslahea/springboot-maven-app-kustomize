pipeline {
    agent { label "k8s-node" }

    parameters {
        string(name: 'SOURCE_BUILD_NUMBER', description: 'Build number passed from CI Job')
    }

    environment {
        AWS_REGION = 'eu-north-1'
        AWS_CRED_ID = 'aws-ecr-creds' 
        S3_BUCKET = "s3://jenkins-artifacts-aslahea-2025"
    }

    stages {
        stage('Clean Workspace') {
            steps { cleanWs() }
        }

        stage('Download Artifact') {
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: AWS_CRED_ID,
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh '''
                        if [ -z "$SOURCE_BUILD_NUMBER" ]; then
                            echo "ERROR: SOURCE_BUILD_NUMBER is empty!"
                            exit 1
                        fi
        
                        aws s3 cp ${S3_BUCKET}/kustomize-pkg-${SOURCE_BUILD_NUMBER}.zip .
                        unzip -o kustomize-pkg-${SOURCE_BUILD_NUMBER}.zip
                    '''
                }
            }
        }


        stage('Deploy to DEV') {
            steps {
                dir('overlays/dev') {
                    sh 'echo "Deploying to DEV..."'
                    sh 'kubectl apply -k .'
                }
            }
        }

        stage('Verify DEV') {
            steps {
                sh 'sleep 5'
                sh 'kubectl get pods -l environment=development' // or just kubectl get pods
            }
        }

        // --- MANUAL APPROVAL (PROD) ---
        stage('Approval for PROD') {
            steps {
                script {
                    // This pauses the pipeline until you click "Proceed" in Jenkins UI
                    input message: 'Do you want to deploy to PRODUCTION?', ok: 'Deploy to Prod'
                }
            }
        }

        // --- PROD DEPLOYMENT ---
        stage('Deploy to PROD') {
            steps {
                dir('overlays/prod') {
                    sh 'echo "Deploying to PRODUCTION..."'
                    // Create prod namespace if needed, or use default with prefix
                    // Here we rely on namePrefix: prod-
                    sh 'kubectl apply -k .'
                }
            }
        }

        stage('Verify PROD') {
            steps {
                sh 'sleep 5'
                // Check specifically for prod pods
                sh 'kubectl get pods | grep prod'
            }
        }
    }
}
